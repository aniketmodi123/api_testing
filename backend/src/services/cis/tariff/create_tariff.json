{
  "meta": {
    "name": "Tariff API",
    "method": "POST",
    "endpoint": "/cis/tariff",
    "headers": {
      "Content-Type": "application/json"
    }
  },
  "cases": [
    {
      "name": "SLAB - valid contiguous (3 rows)",
      "body": {
        "tariff_name": "slab-ok-3rows-${ts}",
        "description": "Valid SLAB - 3 rows contiguous",
        "tariff_type": "SLAB",
        "unit_type": "KW",
        "sector": "Domestic",
        "project_id": [
          "P001",
          "P002"
        ],
        "site_id": [
          "S001"
        ],
        "sanctioned_load_min": 0.5,
        "sanctioned_load_max": 5.0,
        "tariff": [
          {
            "start": 0,
            "end": 100,
            "rate": 3.0
          },
          {
            "start": 100,
            "end": 300,
            "rate": 4.5
          },
          {
            "start": 300,
            "end": null,
            "rate": 5.5
          }
        ],
        "rebate_unit": 10.0,
        "minimum_monthly_charge": 50.0,
        "daily_fixed_charge": 1.5,
        "fixed_monthly_kw_charge_per_unit": 100.0
      },
      "expect": {
        "status": 201,
        "text_contains": "Tariff created successfully",
        "json": {
          "checks": [
            {
              "path": "response_code",
              "equals": 201
            },
            {
              "path": "errors",
              "absent": true
            }
          ]
        }
      }
    },
    {
      "name": "SLAB - valid single open-ended row",
      "body": {
        "tariff_name": "slab-ok-1row-${ts}",
        "description": "Valid SLAB - single row open",
        "tariff_type": "SLAB",
        "unit_type": "KW",
        "sector": "Domestic",
        "project_id": [],
        "site_id": [],
        "sanctioned_load_min": 0.5,
        "sanctioned_load_max": 5.0,
        "tariff": [
          {
            "start": 0,
            "end": null,
            "rate": 2.75
          }
        ],
        "rebate_unit": 0.0,
        "minimum_monthly_charge": 0.0,
        "daily_fixed_charge": 0.0,
        "fixed_monthly_kw_charge_per_unit": 0.0
      },
      "expect": {
        "status": 201,
        "text_contains": "Tariff created successfully",
        "json": {
          "checks": [
            {
              "path": "response_code",
              "equals": 201
            },
            {
              "path": "errors",
              "absent": true
            }
          ]
        }
      }
    },
    {
      "name": "SLAB - FAIL first start != 0",
      "body": {
        "tariff_name": "slab-bad-first-${ts}",
        "description": "",
        "tariff_type": "SLAB",
        "unit_type": "KW",
        "sector": "Domestic",
        "project_id": [],
        "site_id": [],
        "tariff": [
          {
            "start": 1,
            "end": 100,
            "rate": 3.0
          },
          {
            "start": 100,
            "end": 300,
            "rate": 4.5
          },
          {
            "start": 300,
            "end": null,
            "rate": 5.5
          }
        ],
        "rebate_unit": 10.0,
        "minimum_monthly_charge": 50.0,
        "daily_fixed_charge": 1.5,
        "fixed_monthly_kw_charge_per_unit": 100.0
      },
      "expect": {
        "status_in": [
          400,
          422
        ],
        "text_contains": "first row 'start' must be 0",
        "json": {
          "either": [
            {
              "checks": [
                {
                  "path": "error_message",
                  "present": true
                }
              ]
            },
            {
              "checks": [
                {
                  "path": "detail",
                  "present": true
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "SLAB - FAIL non-contiguous (gap/overlap)",
      "body": {
        "tariff_name": "slab-bad-contiguous-${ts}",
        "description": "",
        "tariff_type": "SLAB",
        "unit_type": "KW",
        "sector": "Domestic",
        "project_id": [],
        "site_id": [],
        "tariff": [
          {
            "start": 0,
            "end": 100,
            "rate": 3.0
          },
          {
            "start": 101,
            "end": 300,
            "rate": 4.5
          },
          {
            "start": 300,
            "end": null,
            "rate": 5.5
          }
        ],
        "rebate_unit": 0,
        "minimum_monthly_charge": 0,
        "daily_fixed_charge": 0,
        "fixed_monthly_kw_charge_per_unit": 0
      },
      "expect": {
        "status_in": [
          400,
          422
        ],
        "text_contains": "must equal previous row 'end'",
        "json": {
          "either": [
            {
              "checks": [
                {
                  "path": "error_message",
                  "present": true
                }
              ]
            },
            {
              "checks": [
                {
                  "path": "detail",
                  "present": true
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "SLAB - FAIL last end not null",
      "body": {
        "tariff_name": "slab-bad-last-end-${ts}",
        "description": "",
        "tariff_type": "SLAB",
        "unit_type": "KW",
        "sector": "Domestic",
        "project_id": [],
        "site_id": [],
        "tariff": [
          {
            "start": 0,
            "end": 100,
            "rate": 3.0
          },
          {
            "start": 100,
            "end": 300,
            "rate": 4.0
          },
          {
            "start": 300,
            "end": 400,
            "rate": 5.0
          }
        ],
        "rebate_unit": 0,
        "minimum_monthly_charge": 0,
        "daily_fixed_charge": 0,
        "fixed_monthly_kw_charge_per_unit": 0
      },
      "expect": {
        "status_in": [
          400,
          422
        ],
        "text_contains": "last row 'end' must be null",
        "json": {
          "either": [
            {
              "checks": [
                {
                  "path": "error_message",
                  "present": true
                }
              ]
            },
            {
              "checks": [
                {
                  "path": "detail",
                  "present": true
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "SLAB - FAIL start >= end on non-last row",
      "body": {
        "tariff_name": "slab-bad-order-${ts}",
        "description": "",
        "tariff_type": "SLAB",
        "unit_type": "KW",
        "sector": "Domestic",
        "project_id": [],
        "site_id": [],
        "tariff": [
          {
            "start": 0,
            "end": 100,
            "rate": 3.0
          },
          {
            "start": 100,
            "end": 100,
            "rate": 4.0
          },
          {
            "start": 100,
            "end": null,
            "rate": 5.0
          }
        ],
        "rebate_unit": 0,
        "minimum_monthly_charge": 0,
        "daily_fixed_charge": 0,
        "fixed_monthly_kw_charge_per_unit": 0
      },
      "expect": {
        "status_in": [
          400,
          422
        ],
        "text_contains": "must have start < end",
        "json": {
          "either": [
            {
              "checks": [
                {
                  "path": "error_message",
                  "present": true
                }
              ]
            },
            {
              "checks": [
                {
                  "path": "detail",
                  "present": true
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "SLAB - FAIL non-numeric bounds",
      "body": {
        "tariff_name": "slab-bad-types-${ts}",
        "description": "",
        "tariff_type": "SLAB",
        "unit_type": "KW",
        "sector": "Domestic",
        "project_id": [],
        "site_id": [],
        "tariff": [
          {
            "start": 0,
            "end": 100,
            "rate": 3.0
          },
          {
            "start": "sfkn",
            "end": 300,
            "rate": 4.0
          },
          {
            "start": 300,
            "end": null,
            "rate": 5.0
          }
        ],
        "rebate_unit": 0,
        "minimum_monthly_charge": 0,
        "daily_fixed_charge": 0,
        "fixed_monthly_kw_charge_per_unit": 0
      },
      "expect": {
        "status_in": [
          400,
          422
        ],
        "text_contains": "'start' and 'end' must be numbers",
        "json": {
          "either": [
            {
              "checks": [
                {
                  "path": "error_message",
                  "present": true
                }
              ]
            },
            {
              "checks": [
                {
                  "path": "detail",
                  "present": true
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "SLAB - FAIL rate <= 0",
      "body": {
        "tariff_name": "slab-bad-rate-${ts}",
        "description": "",
        "tariff_type": "SLAB",
        "unit_type": "KW",
        "sector": "Domestic",
        "project_id": [],
        "site_id": [],
        "tariff": [
          {
            "start": 0,
            "end": 100,
            "rate": 0
          },
          {
            "start": 100,
            "end": 300,
            "rate": 4.0
          },
          {
            "start": 300,
            "end": null,
            "rate": 5.0
          }
        ],
        "rebate_unit": 0,
        "minimum_monthly_charge": 0,
        "daily_fixed_charge": 0,
        "fixed_monthly_kw_charge_per_unit": 0
      },
      "expect": {
        "status_in": [
          400,
          422
        ],
        "text_contains": "'rate' must be a number > 0",
        "json": {
          "either": [
            {
              "checks": [
                {
                  "path": "error_message",
                  "present": true
                }
              ]
            },
            {
              "checks": [
                {
                  "path": "detail",
                  "present": true
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "TOD - valid contiguous 0..24",
      "body": {
        "tariff_name": "tod-ok-3slots-${ts}",
        "description": "Valid TOD",
        "tariff_type": "TOD",
        "unit_type": "KW",
        "sector": "Domestic",
        "project_id": [
          "P001"
        ],
        "site_id": [
          "S001"
        ],
        "sanctioned_load_min": 0.5,
        "sanctioned_load_max": 5.0,
        "tariff": [
          {
            "start": 0,
            "end": 6,
            "rate": 2.5
          },
          {
            "start": 6,
            "end": 18,
            "rate": 3.0
          },
          {
            "start": 18,
            "end": 24,
            "rate": 4.0
          }
        ],
        "rebate_unit": 0,
        "minimum_monthly_charge": 0,
        "daily_fixed_charge": 0,
        "fixed_monthly_kw_charge_per_unit": 0
      },
      "expect": {
        "status": 201,
        "text_contains": "Tariff created successfully",
        "json": {
          "checks": [
            {
              "path": "response_code",
              "equals": 201
            },
            {
              "path": "errors",
              "absent": true
            }
          ]
        }
      }
    },
    {
      "name": "TOD - FAIL first start != 0",
      "body": {
        "tariff_name": "tod-bad-first-${ts}",
        "description": "",
        "tariff_type": "TOD",
        "unit_type": "KW",
        "sector": "Domestic",
        "project_id": [],
        "site_id": [],
        "sanctioned_load_min": 0,
        "sanctioned_load_max": 0,
        "tariff": [
          {
            "start": 1,
            "end": 6,
            "rate": 2.5
          },
          {
            "start": 6,
            "end": 18,
            "rate": 3.0
          },
          {
            "start": 18,
            "end": 24,
            "rate": 4.0
          }
        ],
        "rebate_unit": 0,
        "minimum_monthly_charge": 0,
        "daily_fixed_charge": 0,
        "fixed_monthly_kw_charge_per_unit": 0
      },
      "expect": {
        "status_in": [
          400,
          422
        ],
        "text_contains": "first row 'start' must be 0 (00:00 hours)",
        "json": {
          "either": [
            {
              "checks": [
                {
                  "path": "error_message",
                  "present": true
                }
              ]
            },
            {
              "checks": [
                {
                  "path": "detail",
                  "present": true
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "TOD - FAIL last end != 24",
      "body": {
        "tariff_name": "tod-bad-last-${ts}",
        "description": "",
        "tariff_type": "TOD",
        "unit_type": "KW",
        "sector": "Domestic",
        "project_id": [],
        "site_id": [],
        "tariff": [
          {
            "start": 0,
            "end": 6,
            "rate": 2.5
          },
          {
            "start": 6,
            "end": 18,
            "rate": 3.0
          },
          {
            "start": 18,
            "end": 23,
            "rate": 4.0
          }
        ],
        "rebate_unit": 0,
        "minimum_monthly_charge": 0,
        "daily_fixed_charge": 0,
        "fixed_monthly_kw_charge_per_unit": 0
      },
      "expect": {
        "status_in": [
          400,
          422
        ],
        "text_contains": "last row 'end' must be 24",
        "json": {
          "either": [
            {
              "checks": [
                {
                  "path": "error_message",
                  "present": true
                }
              ]
            },
            {
              "checks": [
                {
                  "path": "detail",
                  "present": true
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "TOD - FAIL non-contiguous (end != next.start)",
      "body": {
        "tariff_name": "tod-bad-contiguous-${ts}",
        "description": "",
        "tariff_type": "TOD",
        "unit_type": "KW",
        "sector": "Domestic",
        "project_id": [],
        "site_id": [],
        "tariff": [
          {
            "start": 0,
            "end": 6,
            "rate": 2.5
          },
          {
            "start": 7,
            "end": 18,
            "rate": 3.0
          },
          {
            "start": 18,
            "end": 24,
            "rate": 4.0
          }
        ],
        "rebate_unit": 0,
        "minimum_monthly_charge": 0,
        "daily_fixed_charge": 0,
        "fixed_monthly_kw_charge_per_unit": 0
      },
      "expect": {
        "status_in": [
          400,
          422
        ],
        "text_contains": "must equal next row 'start'",
        "json": {
          "either": [
            {
              "checks": [
                {
                  "path": "error_message",
                  "present": true
                }
              ]
            },
            {
              "checks": [
                {
                  "path": "detail",
                  "present": true
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "TOD - FAIL start >= end",
      "body": {
        "tariff_name": "tod-bad-order-${ts}",
        "description": "",
        "tariff_type": "TOD",
        "unit_type": "KW",
        "sector": "Domestic",
        "project_id": [],
        "site_id": [],
        "tariff": [
          {
            "start": 0,
            "end": 6,
            "rate": 2.5
          },
          {
            "start": 6,
            "end": 6,
            "rate": 3.0
          }
        ],
        "rebate_unit": 0,
        "minimum_monthly_charge": 0,
        "daily_fixed_charge": 0,
        "fixed_monthly_kw_charge_per_unit": 0
      },
      "expect": {
        "status_in": [
          400,
          422
        ],
        "text_contains": "must have start < end",
        "json": {
          "either": [
            {
              "checks": [
                {
                  "path": "error_message",
                  "present": true
                }
              ]
            },
            {
              "checks": [
                {
                  "path": "detail",
                  "present": true
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "TOD - FAIL non-numeric bounds",
      "body": {
        "tariff_name": "tod-bad-types-${ts}",
        "description": "",
        "tariff_type": "TOD",
        "unit_type": "KW",
        "sector": "Domestic",
        "project_id": [],
        "site_id": [],
        "tariff": [
          {
            "start": 0,
            "end": "6",
            "rate": 2.5
          }
        ],
        "rebate_unit": 0,
        "minimum_monthly_charge": 0,
        "daily_fixed_charge": 0,
        "fixed_monthly_kw_charge_per_unit": 0
      },
      "expect": {
        "status_in": [
          400,
          422
        ],
        "text_contains": "'start' and 'end' must be numbers",
        "json": {
          "either": [
            {
              "checks": [
                {
                  "path": "error_message",
                  "present": true
                }
              ]
            },
            {
              "checks": [
                {
                  "path": "detail",
                  "present": true
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "TOD - FAIL rate <= 0",
      "body": {
        "tariff_name": "tod-bad-rate-${ts}",
        "description": "",
        "tariff_type": "TOD",
        "unit_type": "KW",
        "sector": "Domestic",
        "project_id": [],
        "site_id": [],
        "tariff": [
          {
            "start": 0,
            "end": 24,
            "rate": 0
          }
        ],
        "rebate_unit": 0,
        "minimum_monthly_charge": 0,
        "daily_fixed_charge": 0,
        "fixed_monthly_kw_charge_per_unit": 0
      },
      "expect": {
        "status_in": [
          400,
          422
        ],
        "text_contains": "'rate' must be a number > 0",
        "json": {
          "either": [
            {
              "checks": [
                {
                  "path": "error_message",
                  "present": true
                }
              ]
            },
            {
              "checks": [
                {
                  "path": "detail",
                  "present": true
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "FAIL unsupported tariff_type",
      "body": {
        "tariff_name": "bad-type-${ts}",
        "description": "",
        "tariff_type": "UNKNOWN",
        "unit_type": "KW",
        "sector": "Domestic",
        "project_id": [],
        "site_id": [],
        "tariff": [
          {
            "start": 0,
            "end": null,
            "rate": 1
          }
        ],
        "rebate_unit": 0,
        "minimum_monthly_charge": 0,
        "daily_fixed_charge": 0,
        "fixed_monthly_kw_charge_per_unit": 0
      },
      "expect": {
        "status": 400,
        "text_contains": "Unsupported tariff_type",
        "json": {
          "either": [
            {
              "checks": [
                {
                  "path": "detail",
                  "equals": "Unsupported tariff_type"
                }
              ]
            },
            {
              "checks": [
                {
                  "path": "error_message",
                  "present": true
                }
              ]
            }
          ]
        }
      }
    }
  ]
}